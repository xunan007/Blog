# ç”±`setTimeout`å’Œ`setImmediate`æ‰§è¡Œé¡ºåºçš„éšæœºæ€§çª¥æ¢Nodeçš„äº‹ä»¶å¾ªç¯æœºåˆ¶

## é—®é¢˜å¼•å…¥

æ¥è§¦è¿‡äº‹ä»¶å¾ªç¯çš„åŒå­¦å¤§éƒ½ä¼šçº ç»“ä¸€ä¸ªç‚¹ï¼Œå°±æ˜¯åœ¨Nodeä¸­`setTimeout`å’Œ`setImmediate`æ‰§è¡Œé¡ºåºçš„éšæœºæ€§ã€‚

æ¯”å¦‚è¯´ä¸‹é¢è¿™æ®µä»£ç ï¼š

```javascript
setTimeout(() => {
    console.log('setTimeout');
}, 0);
setImmediate(() => {
    console.log('setImmediate');
})
```
æ‰§è¡Œçš„ç»“æœæ˜¯è¿™æ ·å­çš„ï¼š

![](http://oxybu3xjd.bkt.clouddn.com/18-2-2/76500835.jpg)

ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿåˆ«æ€¥ï¼Œæˆ‘ä»¬å…ˆå¾€ä¸‹çœ‹ã€‚

## æµè§ˆå™¨ä¸­äº‹ä»¶å¾ªç¯æ¨¡å‹

æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒJavaScriptæ˜¯å•çº¿ç¨‹çš„è¯­è¨€ï¼Œå¯¹`I/O`çš„æ§åˆ¶æ˜¯é€šè¿‡å¼‚æ­¥æ¥å®ç°çš„ï¼Œå…·ä½“æ˜¯é€šè¿‡â€œäº‹ä»¶å¾ªç¯â€æœºåˆ¶æ¥å®ç°ã€‚

å¯¹äºJavaScriptä¸­çš„å•çº¿ç¨‹ï¼ŒæŒ‡çš„æ˜¯JavaScriptæ‰§è¡Œåœ¨å•çº¿ç¨‹ä¸­ï¼Œè€Œå†…éƒ¨`I/O`ä»»åŠ¡å…¶å®æ˜¯å¦æœ‰çº¿ç¨‹æ± æ¥å®Œæˆçš„ã€‚

åœ¨æµè§ˆå™¨ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºäº‹ä»¶å¾ªç¯ï¼Œæ˜¯ä»¥â€œä»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œï¼Œå†å–å‡ºå¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡â€æ¥åˆ†ææ‰§è¡Œä»£ç çš„ã€‚ä½†æ˜¯åœ¨Nodeç¯å¢ƒä¸­å¹¶ä¸é€‚ç”¨ã€‚å…·ä½“çš„æµè§ˆå™¨äº‹ä»¶å¾ªç¯è§£æï¼š[ä¼ é€é—¨](http://www.yangzicong.com/article/3)

åœ¨Nodeä¸­ï¼Œäº‹ä»¶å¾ªç¯çš„æ¨¡å‹å’Œæµè§ˆå™¨ç›¸æ¯”å¤§è‡´ç›¸åŒï¼Œè€Œæœ€å¤§çš„ä¸åŒç‚¹åœ¨äºNodeä¸­äº‹ä»¶å¾ªç¯åˆ†ä¸åŒçš„é˜¶æ®µã€‚å…·ä½“æˆ‘ä»¬ä¸‹é¢ä¼šè®¨è®ºåˆ°ã€‚æœ¬æ–‡çš„æ ¸å¿ƒä¹Ÿåœ¨è¿™é‡Œã€‚

## Nodeä¸­äº‹ä»¶å¾ªç¯é˜¶æ®µè§£æ

ä¸‹é¢æ˜¯äº‹ä»¶å¾ªç¯ä¸åŒé˜¶æ®µçš„ç¤ºæ„å›¾ï¼š

![](http://oxybu3xjd.bkt.clouddn.com/18-3-12/4053975.jpg)

æ¯ä¸ªé˜¶æ®µéƒ½æœ‰ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„å›è°ƒé˜Ÿåˆ—è¦æ‰§è¡Œã€‚è€Œæ¯ä¸ªé˜¶æ®µéƒ½æœ‰è‡ªå·±çš„ç‰¹æ®Šä¹‹å¤„ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å½“äº‹ä»¶å¾ªç¯è¿›å…¥æŸä¸ªé˜¶æ®µåï¼Œä¼šæ‰§è¡Œè¯¥é˜¶æ®µç‰¹å®šçš„ä»»æ„æ“ä½œï¼Œç„¶åæ‰ä¼šæ‰§è¡Œè¿™ä¸ªé˜¶æ®µé‡Œçš„å›è°ƒã€‚å½“é˜Ÿåˆ—è¢«æ‰§è¡Œå®Œï¼Œæˆ–è€…æ‰§è¡Œçš„å›è°ƒæ•°é‡è¾¾åˆ°ä¸Šé™åï¼Œäº‹ä»¶å¾ªç¯æ‰ä¼šè¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚

ä»¥ä¸‹æ˜¯å„ä¸ªé˜¶æ®µè¯¦æƒ…ã€‚

### timers

ä¸€ä¸ª`timer`æŒ‡å®šä¸€ä¸ªä¸‹é™æ—¶é—´è€Œä¸æ˜¯å‡†ç¡®æ—¶é—´ï¼Œåœ¨è¾¾åˆ°è¿™ä¸ªä¸‹é™æ—¶é—´åæ‰§è¡Œå›è°ƒã€‚åœ¨æŒ‡å®šçš„æ—¶é—´è¿‡åï¼Œ`timers`ä¼šå°½æ—©çš„æ‰§è¡Œå›è°ƒï¼Œä½†æ˜¯ç³»ç»Ÿè°ƒåº¦æˆ–è€…å…¶ä»–å›è°ƒçš„æ‰§è¡Œå¯èƒ½ä¼šå»¶è¿Ÿå®ƒä»¬ã€‚

> ä»æŠ€æœ¯ä¸Šæ¥è¯´ï¼Œ`poll`é˜¶æ®µæ§åˆ¶`timers`ä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Œè€Œæ‰§è¡Œçš„å…·ä½“ä½ç½®åœ¨`timers`ã€‚

ä¸‹é™çš„æ—¶é—´æœ‰ä¸€ä¸ªèŒƒå›´ï¼š`[1, 2147483647]`ï¼Œå¦‚æœè®¾å®šçš„æ—¶é—´ä¸åœ¨è¿™ä¸ªèŒƒå›´ï¼Œå°†è¢«è®¾ç½®ä¸º1ã€‚

### idle, prepare 

ç³»ç»Ÿå†…éƒ¨çš„ä¸€äº›è°ƒç”¨ã€‚

### I/O callbacks

è¿™ä¸ªé˜¶æ®µæ‰§è¡Œä¸€äº›ç³»ç»Ÿæ“ä½œçš„å›è°ƒï¼Œæ¯”å¦‚è¯´TCPè¿æ¥å‘ç”Ÿé”™è¯¯ã€‚

### poll

è¿™æ˜¯æœ€å¤æ‚çš„ä¸€ä¸ªé˜¶æ®µã€‚

`poll`é˜¶æ®µæœ‰ä¸¤ä¸ªä¸»è¦çš„åŠŸèƒ½ï¼šä¸€æ˜¯æ‰§è¡Œä¸‹é™æ—¶é—´å·²ç»è¾¾åˆ°çš„`timers`çš„å›è°ƒï¼Œä¸€æ˜¯å¤„ç†`poll`é˜Ÿåˆ—é‡Œçš„**äº‹ä»¶**ã€‚

æ³¨ï¼šNodeå¾ˆå¤šAPIéƒ½æ˜¯åŸºäºäº‹ä»¶è®¢é˜…å®Œæˆçš„ï¼Œè¿™äº›APIçš„å›è°ƒåº”è¯¥éƒ½åœ¨`poll`é˜¶æ®µå®Œæˆã€‚

ä»¥ä¸‹æ˜¯Nodeå®˜ç½‘çš„ä»‹ç»ï¼š

![](http://oxybu3xjd.bkt.clouddn.com/18-2-2/76866942.jpg)

ç¬”è€…æŠŠå®˜ç½‘é™ˆè¿°çš„æƒ…å†µä»¥ä¸åŒçš„æ¡ä»¶åˆ†è§£ï¼Œæ›´åŠ çš„æ¸…æ¥šã€‚ï¼ˆå¦‚æœæœ‰è¯¯ï¼Œå¸ˆè¯·æ”¹æ­£ã€‚ï¼‰

å½“äº‹ä»¶å¾ªç¯è¿›å…¥`poll`é˜¶æ®µï¼š
- `poll`é˜Ÿåˆ—ä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œäº‹ä»¶å¾ªç¯è‚¯å®šæ˜¯å…ˆéå†é˜Ÿåˆ—å¹¶åŒæ­¥æ‰§è¡Œå›è°ƒï¼Œç›´åˆ°é˜Ÿåˆ—æ¸…ç©ºæˆ–æ‰§è¡Œå›è°ƒæ•°è¾¾åˆ°ç³»ç»Ÿä¸Šé™ã€‚
- `poll`é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ï¼Œè¿™é‡Œæœ‰ä¸¤ç§æƒ…å†µã€‚
    - å¦‚æœä»£ç å·²ç»è¢«`setImmediate()`è®¾å®šäº†å›è°ƒï¼Œé‚£ä¹ˆäº‹ä»¶å¾ªç¯ç›´æ¥ç»“æŸ`poll`é˜¶æ®µè¿›å…¥`check`é˜¶æ®µæ¥æ‰§è¡Œ`check`é˜Ÿåˆ—é‡Œçš„å›è°ƒã€‚
    - å¦‚æœä»£ç æ²¡æœ‰è¢«è®¾å®š`setImmediate()`è®¾å®šå›è°ƒï¼š
        - å¦‚æœæœ‰è¢«è®¾å®šçš„`timers`ï¼Œé‚£ä¹ˆæ­¤æ—¶äº‹ä»¶å¾ªç¯ä¼šæ£€æŸ¥`timers`ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæˆ–å¤šä¸ª`timers`ä¸‹é™æ—¶é—´å·²ç»åˆ°è¾¾ï¼Œé‚£ä¹ˆäº‹ä»¶å¾ªç¯å°†ç»•å›`timers`é˜¶æ®µï¼Œå¹¶æ‰§è¡Œ`timers`çš„æœ‰æ•ˆå›è°ƒé˜Ÿåˆ—ã€‚
        - å¦‚æœæ²¡æœ‰è¢«è®¾å®š`timers`ï¼Œè¿™ä¸ªæ—¶å€™äº‹ä»¶å¾ªç¯æ˜¯é˜»å¡åœ¨`poll`é˜¶æ®µç­‰å¾…å›è°ƒè¢«åŠ å…¥`poll`é˜Ÿåˆ—ã€‚
    

### check

è¿™ä¸ªé˜¶æ®µå…è®¸åœ¨`poll`é˜¶æ®µç»“æŸåç«‹å³æ‰§è¡Œå›è°ƒã€‚å¦‚æœ`poll`é˜¶æ®µç©ºé—²ï¼Œå¹¶ä¸”æœ‰è¢«`setImmediate()`è®¾å®šçš„å›è°ƒï¼Œé‚£ä¹ˆäº‹ä»¶å¾ªç¯ç›´æ¥è·³åˆ°`check`æ‰§è¡Œè€Œä¸æ˜¯é˜»å¡åœ¨`poll`é˜¶æ®µç­‰å¾…å›è°ƒè¢«åŠ å…¥ã€‚

`setImmediate()`å®é™…ä¸Šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„`timer`ï¼Œè·‘åœ¨äº‹ä»¶å¾ªç¯ä¸­çš„ä¸€ä¸ªç‹¬ç«‹çš„é˜¶æ®µã€‚å®ƒä½¿ç”¨`libuv`çš„`API`æ¥è®¾å®šåœ¨`poll`é˜¶æ®µç»“æŸåç«‹å³æ‰§è¡Œå›è°ƒã€‚

**æ³¨ï¼š`setImmediate()`å…·æœ‰æœ€é«˜ä¼˜å…ˆçº§ï¼Œåªè¦`poll`é˜Ÿåˆ—ä¸ºç©ºï¼Œä»£ç è¢«`setImmediate()`ï¼Œæ— è®ºæ˜¯å¦æœ‰`timers`è¾¾åˆ°ä¸‹é™æ—¶é—´ï¼Œ`setImmediate()`çš„ä»£ç éƒ½å…ˆæ‰§è¡Œã€‚**

### close callbacks

å¦‚æœä¸€ä¸ª`socket`æˆ–`handle`è¢«çªç„¶å…³æ‰ï¼ˆæ¯”å¦‚`socket.destroy()`ï¼‰ï¼Œ`close`äº‹ä»¶å°†åœ¨è¿™ä¸ªé˜¶æ®µè¢«è§¦å‘ï¼Œå¦åˆ™å°†é€šè¿‡`process.nextTick()`è§¦å‘ã€‚

## å…³äºsetTimeoutå’ŒsetImmediate

ä»£ç é‡ç°ï¼Œæˆ‘ä»¬ä¼šå‘ç°`setTimeout`å’Œ`setImmediate`åœ¨Nodeç¯å¢ƒä¸‹æ‰§è¡Œæ˜¯é â€œéšç¼˜æ³•åˆ™â€çš„ã€‚

æ¯”å¦‚è¯´ä¸‹é¢è¿™æ®µä»£ç ï¼š

```javascript
setTimeout(() => {
    console.log('setTimeout');
}, 0);
setImmediate(() => {
    console.log('setImmediate');
})
```
æ‰§è¡Œçš„ç»“æœæ˜¯è¿™æ ·å­çš„ï¼š

![](http://oxybu3xjd.bkt.clouddn.com/18-2-2/76500835.jpg)

ä¸ºä»€ä¹ˆä¼šè¿™æ ·å­å‘¢ï¼Ÿ

è¿™é‡Œæˆ‘ä»¬è¦æ ¹æ®å‰é¢çš„é‚£ä¸ªäº‹ä»¶å¾ªç¯ä¸åŒé˜¶æ®µçš„å›¾è§£æ¥è¯´æ˜ä¸€ä¸‹ï¼š

é¦–å…ˆè¿›å…¥çš„æ˜¯`timers`é˜¶æ®µï¼Œå¦‚æœæˆ‘ä»¬çš„æœºå™¨æ€§èƒ½ä¸€èˆ¬ï¼Œé‚£ä¹ˆè¿›å…¥`timers`é˜¶æ®µï¼Œä¸€æ¯«ç§’å·²ç»è¿‡å»äº†ï¼ˆ`setTimeout(fn, 0)`ç­‰ä»·äº`setTimeout(fn, 1)`ï¼‰ï¼Œé‚£ä¹ˆ`setTimeout`çš„å›è°ƒä¼šé¦–å…ˆæ‰§è¡Œã€‚

å¦‚æœæ²¡æœ‰åˆ°ä¸€æ¯«ç§’ï¼Œé‚£ä¹ˆåœ¨`timers`é˜¶æ®µçš„æ—¶å€™ï¼Œä¸‹é™æ—¶é—´æ²¡åˆ°ï¼Œ`setTimeout`å›è°ƒä¸æ‰§è¡Œï¼Œäº‹ä»¶å¾ªç¯æ¥åˆ°äº†`poll`é˜¶æ®µï¼Œè¿™ä¸ªæ—¶å€™é˜Ÿåˆ—ä¸ºç©ºï¼Œæ­¤æ—¶æœ‰ä»£ç è¢«`setImmediate()`ï¼Œäºæ˜¯å…ˆæ‰§è¡Œäº†`setImmediate()`çš„å›è°ƒå‡½æ•°ï¼Œä¹‹ååœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯å†æ‰§è¡Œ`setTimemout`çš„å›è°ƒå‡½æ•°ã€‚

è€Œæˆ‘ä»¬åœ¨æ‰§è¡Œä»£ç çš„æ—¶å€™ï¼Œè¿›å…¥`timers`çš„æ—¶é—´å»¶è¿Ÿå…¶å®æ˜¯éšæœºçš„ï¼Œå¹¶ä¸æ˜¯ç¡®å®šçš„ï¼Œæ‰€ä»¥ä¼šå‡ºç°ä¸¤ä¸ªå‡½æ•°æ‰§è¡Œé¡ºåºéšæœºçš„æƒ…å†µã€‚

é‚£æˆ‘ä»¬å†æ¥çœ‹ä¸€æ®µä»£ç ï¼š

```javascript
var fs = require('fs')

fs.readFile(__filename, () => {
    setTimeout(() => {
        console.log('timeout');
    }, 0);
    setImmediate(() => {
        console.log('immediate');
    });
});
```
è¿™é‡Œæˆ‘ä»¬å°±ä¼šå‘ç°ï¼Œ`setImmediate`æ°¸è¿œå…ˆäº`setTimeout`æ‰§è¡Œã€‚

åŸå› å¦‚ä¸‹ï¼š

`fs.readFile`çš„å›è°ƒæ˜¯åœ¨`poll`é˜¶æ®µæ‰§è¡Œçš„ï¼Œå½“å…¶å›è°ƒæ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œ`poll`é˜Ÿåˆ—ä¸ºç©ºï¼Œè€Œ`setTimeout`å…¥äº†`timers`çš„é˜Ÿåˆ—ï¼Œæ­¤æ—¶æœ‰ä»£ç è¢«`setImmediate()`ï¼Œäºæ˜¯äº‹ä»¶å¾ªç¯å…ˆè¿›å…¥`check`é˜¶æ®µæ‰§è¡Œå›è°ƒï¼Œä¹‹ååœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯å†åœ¨`timers`é˜¶æ®µä¸­æ‰§è¡Œæœ‰æ•ˆå›è°ƒã€‚

åŒæ ·çš„ï¼Œè¿™æ®µä»£ç ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼š

```javascript
setTimeout(() => {
    setImmediate(() => {
        console.log('setImmediate');
    });
    setTimeout(() => {
        console.log('setTimeout');
    }, 0);
}, 0);
```
ä»¥ä¸Šçš„ä»£ç åœ¨`timers`é˜¶æ®µæ‰§è¡Œå¤–éƒ¨çš„`setTimeout`å›è°ƒåï¼Œå†…å±‚çš„`setTimeout`å’Œ`setImmediate`å…¥é˜Ÿï¼Œä¹‹åäº‹ä»¶å¾ªç¯ç»§ç»­å¾€åé¢çš„é˜¶æ®µèµ°ï¼Œèµ°åˆ°`poll`é˜¶æ®µçš„æ—¶å€™å‘ç°é˜Ÿåˆ—ä¸ºç©ºï¼Œæ­¤æ—¶æœ‰ä»£ç è¢«`setImmedate()`ï¼Œæ‰€ä»¥ç›´æ¥è¿›å…¥`check`é˜¶æ®µæ‰§è¡Œå“åº”å›è°ƒï¼ˆæ³¨æ„è¿™é‡Œæ²¡æœ‰å»æ£€æµ‹`timers`é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰æˆå‘˜åˆ°è¾¾ä¸‹é™äº‹ä»¶ï¼Œå› ä¸º`setImmediate()`ä¼˜å…ˆï¼‰ã€‚ä¹‹ååœ¨ç¬¬äºŒä¸ªäº‹ä»¶å¾ªç¯çš„`timers`é˜¶æ®µä¸­å†å»æ‰§è¡Œç›¸åº”çš„å›è°ƒã€‚

ç»¼ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“ï¼š
- å¦‚æœä¸¤è€…éƒ½åœ¨ä¸»æ¨¡å—ä¸­è°ƒç”¨ï¼Œé‚£ä¹ˆæ‰§è¡Œå…ˆåå–å†³äºè¿›ç¨‹æ€§èƒ½ï¼Œä¹Ÿå°±æ˜¯éšæœºã€‚
- å¦‚æœä¸¤è€…éƒ½ä¸åœ¨ä¸»æ¨¡å—è°ƒç”¨ï¼ˆè¢«ä¸€ä¸ªå¼‚æ­¥æ“ä½œåŒ…è£¹ï¼‰ï¼Œé‚£ä¹ˆ`setImmediate`çš„å›è°ƒæ°¸è¿œå…ˆæ‰§è¡Œã€‚

### process.nextTick() and Promise

å¯¹äºè¿™ä¸¤ä¸ªï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒä»¬ç†è§£æˆä¸€ä¸ªå¾®ä»»åŠ¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå…¶å®ä¸å±äºäº‹ä»¶å¾ªç¯çš„ä¸€éƒ¨åˆ†ã€‚

é‚£ä¹ˆä»–ä»¬æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå‘¢ï¼Ÿ

ä¸ç®¡åœ¨ä»€ä¹ˆåœ°æ–¹è°ƒç”¨ï¼Œä»–ä»¬éƒ½ä¼šåœ¨å…¶æ‰€å¤„çš„äº‹ä»¶å¾ªç¯æœ€åï¼Œäº‹ä»¶å¾ªç¯è¿›å…¥ä¸‹ä¸€ä¸ªå¾ªç¯çš„é˜¶æ®µå‰æ‰§è¡Œã€‚

ä¸¾ä¸ªğŸŒ°ï¼š

```javascript
setTimeout(() => {
    console.log('timeout0');
    process.nextTick(() => {
        console.log('nextTick1');
        process.nextTick(() => {
            console.log('nextTick2');
        });
    });
    process.nextTick(() => {
        console.log('nextTick3');
    });
    console.log('sync');
    setTimeout(() => {
        console.log('timeout2');
    }, 0);
}, 0);
```

ç»“æœæ˜¯ï¼š

![](http://oxybu3xjd.bkt.clouddn.com/18-2-2/10050363.jpg)

å†è§£é‡Šä¸€ä¸‹ï¼š

`timers`é˜¶æ®µæ‰§è¡Œå¤–å±‚`setTimeout`çš„å›è°ƒï¼Œé‡åˆ°åŒæ­¥ä»£ç å…ˆæ‰§è¡Œï¼Œä¹Ÿå°±æœ‰`timeout0`ã€`sync`çš„è¾“å‡ºã€‚é‡åˆ°`process.nextTick`åå…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œä¾æ¬¡`nextTick1`ã€`nextTick3`ã€`nextTick2`å…¥é˜Ÿåå‡ºé˜Ÿè¾“å‡ºã€‚ä¹‹åï¼Œåœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯çš„`timers`é˜¶æ®µï¼Œæ‰§è¡Œ`setTimeout`å›è°ƒè¾“å‡º`timeout2`ã€‚

### æœ€å

ä¸‹é¢ç»™å‡ºä¸¤æ®µä»£ç ï¼Œå¦‚æœèƒ½å¤Ÿç†è§£å…¶æ‰§è¡Œé¡ºåºè¯´æ˜ä½ å·²ç»ç†è§£é€å½»ã€‚

ä»£ç 1ï¼š

```javascript
setImmediate(function(){
  console.log("setImmediate");
  setImmediate(function(){
    console.log("åµŒå¥—setImmediate");
  });
  process.nextTick(function(){
    console.log("nextTick");
  })
});

// setImmediate
// nextTick
// åµŒå¥—setImmediate
```

è§£æï¼šäº‹ä»¶å¾ªç¯`check`é˜¶æ®µæ‰§è¡Œå›è°ƒå‡½æ•°è¾“å‡º`setImmediate`ï¼Œä¹‹åè¾“å‡º`nextTick`ã€‚åµŒå¥—çš„`setImmediate`åœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯çš„`check`é˜¶æ®µæ‰§è¡Œå›è°ƒè¾“å‡ºåµŒå¥—çš„`setImmediate`ã€‚

ä»£ç 2ï¼š

```javascript
var fs = require('fs');

function someAsyncOperation (callback) {
  // å‡è®¾è¿™ä¸ªä»»åŠ¡è¦æ¶ˆè€— 95ms
  fs.readFile('/path/to/file', callback);
}

var timeoutScheduled = Date.now();

setTimeout(function () {

  var delay = Date.now() - timeoutScheduled;

  console.log(delay + "ms have passed since I was scheduled");
}, 100);


// someAsyncOperationè¦æ¶ˆè€— 95 ms æ‰èƒ½å®Œæˆ
someAsyncOperation(function () {

  var startCallback = Date.now();

  // æ¶ˆè€— 10ms...
  while (Date.now() - startCallback < 10) {
    ; // do nothing
  }

});
```

è§£æï¼šäº‹ä»¶å¾ªç¯è¿›å…¥`poll`é˜¶æ®µå‘ç°é˜Ÿåˆ—ä¸ºç©ºï¼Œå¹¶ä¸”æ²¡æœ‰ä»£ç è¢«`setImmediate()`ã€‚äºæ˜¯åœ¨`poll`é˜¶æ®µç­‰å¾…`timers`ä¸‹é™æ—¶é—´åˆ°è¾¾ã€‚å½“ç­‰åˆ°`95ms`æ—¶ï¼Œ`fs.readFile`é¦–å…ˆæ‰§è¡Œäº†ï¼Œå®ƒçš„å›è°ƒè¢«æ·»åŠ è¿›`poll`é˜Ÿåˆ—å¹¶åŒæ­¥æ‰§è¡Œï¼Œè€—æ—¶`10ms`ã€‚æ­¤æ—¶æ€»å…±æ—¶é—´ç´¯ç§¯`105ms`ã€‚ç­‰åˆ°`poll`é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ï¼Œäº‹ä»¶å¾ªç¯ä¼šæŸ¥çœ‹æœ€è¿‘åˆ°è¾¾çš„`timer`çš„ä¸‹é™æ—¶é—´ï¼Œå‘ç°å·²ç»åˆ°è¾¾ï¼Œå†å›åˆ°`timers`é˜¶æ®µï¼Œæ‰§è¡Œ`timer`çš„å›è°ƒã€‚

---

å¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œæ¬¢è¿ç•™è¨€äº¤æµæ¢è®¨ã€‚

å‚è€ƒé“¾æ¥ï¼š

https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/  

https://github.com/creeperyang/blog/issues/26


